# coding:utf-8

all_tag_str = '''<div class="article">

<div style="border-bottom: 1px solid rgb(204, 204, 204); padding-bottom: 5px; margin-bottom: 10px;" class="clearfix">

    <span class="rr greyinput">
        <a href="https://movie.douban.com/tag/?view=type">分类浏览</a> /
        所有热门标签
    </span>
</div>
      <div class="indent tag_cloud">
        <table class="tagCol">
          <tbody>
                <tr>
              <td><a href="/tag/美国">美国</a><b>(18143728)</b></td>
              <td><a href="/tag/爱情">爱情</a><b>(11041425)</b></td>
              <td><a href="/tag/喜剧">喜剧</a><b>(9254071)</b></td>
              <td><a href="/tag/动画">动画</a><b>(7096561)</b></td>
                </tr>
                <tr>
              <td><a href="/tag/剧情">剧情</a><b>(6980171)</b></td>
              <td><a href="/tag/科幻">科幻</a><b>(5988020)</b></td>
              <td><a href="/tag/日本">日本</a><b>(5729533)</b></td>
              <td><a href="/tag/动作">动作</a><b>(5615077)</b></td>
                </tr>
                <tr>
              <td><a href="/tag/经典">经典</a><b>(5271627)</b></td>
              <td><a href="/tag/香港">香港</a><b>(4716974)</b></td>
              <td><a href="/tag/悬疑">悬疑</a><b>(4525109)</b></td>
              <td><a href="/tag/青春">青春</a><b>(4165377)</b></td>
                </tr>
                <tr>
              <td><a href="/tag/美国电影">美国电影</a><b>(3816197)</b></td>
              <td><a href="/tag/人性">人性</a><b>(3619231)</b></td>
              <td><a href="/tag/电影">电影</a><b>(3762431)</b></td>
              <td><a href="/tag/犯罪">犯罪</a><b>(3713852)</b></td>
                </tr>
                <tr>
              <td><a href="/tag/美剧">美剧</a><b>(3114832)</b></td>
              <td><a href="/tag/惊悚">惊悚</a><b>(2838245)</b></td>
              <td><a href="/tag/英国">英国</a><b>(2843761)</b></td>
              <td><a href="/tag/中国">中国</a><b>(2806253)</b></td>
                </tr>
                <tr>
              <td><a href="/tag/文艺">文艺</a><b>(2615985)</b></td>
              <td><a href="/tag/日剧">日剧</a><b>(2498386)</b></td>
              <td><a href="/tag/温情">温情</a><b>(2475017)</b></td>
              <td><a href="/tag/韩国">韩国</a><b>(2381047)</b></td>
                </tr>
                <tr>
              <td><a href="/tag/搞笑">搞笑</a><b>(2425924)</b></td>
              <td><a href="/tag/法国">法国</a><b>(2388469)</b></td>
              <td><a href="/tag/纪录片">纪录片</a><b>(2237872)</b></td>
              <td><a href="/tag/电视剧">电视剧</a><b>(2241486)</b></td>
                </tr>
                <tr>
              <td><a href="/tag/香港电影">香港电影</a><b>(2150320)</b></td>
              <td><a href="/tag/成长">成长</a><b>(2002464)</b></td>
              <td><a href="/tag/励志">励志</a><b>(2101672)</b></td>
              <td><a href="/tag/恐怖">恐怖</a><b>(1786791)</b></td>
                </tr>
                <tr>
              <td><a href="/tag/战争">战争</a><b>(1793292)</b></td>
              <td><a href="/tag/奇幻">奇幻</a><b>(1607879)</b></td>
              <td><a href="/tag/人生">人生</a><b>(1455284)</b></td>
              <td><a href="/tag/短片">短片</a><b>(1515976)</b></td>
                </tr>
                <tr>
              <td><a href="/tag/黑色幽默">黑色幽默</a><b>(1398193)</b></td>
              <td><a href="/tag/日本电影">日本电影</a><b>(1461893)</b></td>
              <td><a href="/tag/日本动画">日本动画</a><b>(1449719)</b></td>
              <td><a href="/tag/大陆">大陆</a><b>(1452482)</b></td>
                </tr>
                <tr>
              <td><a href="/tag/魔幻">魔幻</a><b>(1401000)</b></td>
              <td><a href="/tag/台湾">台湾</a><b>(1358401)</b></td>
              <td><a href="/tag/中国电影">中国电影</a><b>(1343029)</b></td>
              <td><a href="/tag/动漫">动漫</a><b>(1297563)</b></td>
                </tr>
                <tr>
              <td><a href="/tag/2016">2016</a><b>(1232231)</b></td>
              <td><a href="/tag/2015">2015</a><b>(1218744)</b></td>
              <td><a href="/tag/亲情">亲情</a><b>(1227053)</b></td>
              <td><a href="/tag/心理">心理</a><b>(1115030)</b></td>
                </tr>
                <tr>
              <td><a href="/tag/2013">2013</a><b>(1188140)</b></td>
              <td><a href="/tag/传记">传记</a><b>(1168381)</b></td>
              <td><a href="/tag/冒险">冒险</a><b>(1146149)</b></td>
              <td><a href="/tag/2014">2014</a><b>(1130669)</b></td>
                </tr>
                <tr>
              <td><a href="/tag/2011">2011</a><b>(1112988)</b></td>
              <td><a href="/tag/韩剧">韩剧</a><b>(1093361)</b></td>
              <td><a href="/tag/情色">情色</a><b>(1074719)</b></td>
              <td><a href="/tag/2012">2012</a><b>(1085765)</b></td>
                </tr>
                <tr>
              <td><a href="/tag/英剧">英剧</a><b>(1084008)</b></td>
              <td><a href="/tag/看过的电视剧">看过的电视剧</a><b>(926483)</b></td>
              <td><a href="/tag/历史">历史</a><b>(1028222)</b></td>
              <td><a href="/tag/感人">感人</a><b>(1001108)</b></td>
                </tr>
                <tr>
              <td><a href="/tag/2010">2010</a><b>(987465)</b></td>
              <td><a href="/tag/暴力">暴力</a><b>(985272)</b></td>
              <td><a href="/tag/家庭">家庭</a><b>(862341)</b></td>
              <td><a href="/tag/韩国电影">韩国电影</a><b>(916168)</b></td>
                </tr>
                <tr>
              <td><a href="/tag/动画短片">动画短片</a><b>(885404)</b></td>
              <td><a href="/tag/音乐">音乐</a><b>(801040)</b></td>
              <td><a href="/tag/国产电视剧">国产电视剧</a><b>(848003)</b></td>
              <td><a href="/tag/2009">2009</a><b>(810250)</b></td>
                </tr>
                <tr>
              <td><a href="/tag/法国电影">法国电影</a><b>(764193)</b></td>
              <td><a href="/tag/TVB">TVB</a><b>(759315)</b></td>
              <td><a href="/tag/中国大陆">中国大陆</a><b>(554746)</b></td>
              <td><a href="/tag/童年">童年</a><b>(736966)</b></td>
                </tr>
                <tr>
              <td><a href="/tag/灾难">灾难</a><b>(735260)</b></td>
              <td><a href="/tag/浪漫">浪漫</a><b>(696904)</b></td>
              <td><a href="/tag/感动">感动</a><b>(587098)</b></td>
              <td><a href="/tag/周星驰">周星驰</a><b>(665089)</b></td>
                </tr>
                <tr>
              <td><a href="/tag/宫崎骏">宫崎骏</a><b>(686237)</b></td>
              <td><a href="/tag/BBC">BBC</a><b>(662881)</b></td>
              <td><a href="/tag/黑帮">黑帮</a><b>(641370)</b></td>
              <td><a href="/tag/女性">女性</a><b>(644667)</b></td>
                </tr>
                <tr>
              <td><a href="/tag/武侠">武侠</a><b>(626409)</b></td>
              <td><a href="/tag/古装">古装</a><b>(655425)</b></td>
              <td><a href="/tag/德国">德国</a><b>(625335)</b></td>
              <td><a href="/tag/漫画改编">漫画改编</a><b>(609454)</b></td>
                </tr>
                <tr>
              <td><a href="/tag/3D">3D</a><b>(597370)</b></td>
              <td><a href="/tag/推理">推理</a><b>(618481)</b></td>
              <td><a href="/tag/意大利">意大利</a><b>(612304)</b></td>
              <td><a href="/tag/二战">二战</a><b>(547888)</b></td>
                </tr>
                <tr>
              <td><a href="/tag/同志">同志</a><b>(580905)</b></td>
              <td><a href="/tag/国产">国产</a><b>(542065)</b></td>
              <td><a href="/tag/小说改编">小说改编</a><b>(510010)</b></td>
              <td><a href="/tag/校园">校园</a><b>(567593)</b></td>
                </tr>
                <tr>
              <td><a href="/tag/同性">同性</a><b>(554710)</b></td>
              <td><a href="/tag/2008">2008</a><b>(555634)</b></td>
              <td><a href="/tag/动画片">动画片</a><b>(550863)</b></td>
              <td><a href="/tag/政治">政治</a><b>(504807)</b></td>
                </tr>
                <tr>
              <td><a href="/tag/史诗">史诗</a><b>(533072)</b></td>
              <td><a href="/tag/烂片">烂片</a><b>(482763)</b></td>
              <td><a href="/tag/台湾电影">台湾电影</a><b>(507563)</b></td>
              <td><a href="/tag/英国电影">英国电影</a><b>(485178)</b></td>
                </tr>
                <tr>
              <td><a href="/tag/2007">2007</a><b>(454490)</b></td>
              <td><a href="/tag/警匪">警匪</a><b>(428539)</b></td>
              <td><a href="/tag/童话">童话</a><b>(427319)</b></td>
              <td><a href="/tag/血腥">血腥</a><b>(435466)</b></td>
                </tr>
                <tr>
              <td><a href="/tag/港剧">港剧</a><b>(417566)</b></td>
              <td><a href="/tag/印度">印度</a><b>(400064)</b></td>
              <td><a href="/tag/内地">内地</a><b>(404856)</b></td>
              <td><a href="/tag/特工">特工</a><b>(391746)</b></td>
                </tr>
                <tr>
              <td><a href="/tag/宗教">宗教</a><b>(366370)</b></td>
              <td><a href="/tag/吸血鬼">吸血鬼</a><b>(399124)</b></td>
              <td><a href="/tag/泰国">泰国</a><b>(388875)</b></td>
              <td><a href="/tag/迪斯尼">迪斯尼</a><b>(380632)</b></td>
                </tr>
                <tr>
              <td><a href="/tag/西班牙">西班牙</a><b>(372782)</b></td>
              <td><a href="/tag/王家卫">王家卫</a><b>(368836)</b></td>
              <td><a href="/tag/2006">2006</a><b>(373070)</b></td>
              <td><a href="/tag/儿童">儿童</a><b>(341725)</b></td>
                </tr>
                <tr>
              <td><a href="/tag/国产动画">国产动画</a><b>(356455)</b></td>
              <td><a href="/tag/欧美">欧美</a><b>(339962)</b></td>
              <td><a href="/tag/友情">友情</a><b>(317822)</b></td>
              <td><a href="/tag/剧场版">剧场版</a><b>(337966)</b></td>
                </tr>
                <tr>
              <td><a href="/tag/梦工厂">梦工厂</a><b>(329970)</b></td>
              <td><a href="/tag/JohnnyDepp">JohnnyDepp</a><b>(329409)</b></td>
              <td><a href="/tag/岩井俊二">岩井俊二</a><b>(318466)</b></td>
              <td><a href="/tag/动物">动物</a><b>(317590)</b></td>
                </tr>
                <tr>
              <td><a href="/tag/梦想">梦想</a><b>(267060)</b></td>
              <td><a href="/tag/梁朝伟">梁朝伟</a><b>(283964)</b></td>
              <td><a href="/tag/2004">2004</a><b>(292961)</b></td>
              <td><a href="/tag/黑色">黑色</a><b>(267536)</b></td>
                </tr>
                <tr>
              <td><a href="/tag/2005">2005</a><b>(269756)</b></td>
              <td><a href="/tag/张艺谋">张艺谋</a><b>(295584)</b></td>
              <td><a href="/tag/童年回忆">童年回忆</a><b>(276325)</b></td>
              <td><a href="/tag/美食">美食</a><b>(250706)</b></td>
                </tr>
                <tr>
              <td><a href="/tag/名著改编">名著改编</a><b>(267176)</b></td>
              <td><a href="/tag/信念">信念</a><b>(252831)</b></td>
              <td><a href="/tag/伦理">伦理</a><b>(251967)</b></td>
              <td><a href="/tag/超级英雄">超级英雄</a><b>(267146)</b></td>
                </tr>
                <tr>
              <td><a href="/tag/歌舞">歌舞</a><b>(222465)</b></td>
              <td><a href="/tag/2000s">2000s</a><b>(265281)</b></td>
              <td><a href="/tag/尼古拉斯·凯奇">尼古拉斯·凯奇</a><b>(259483)</b></td>
              <td><a href="/tag/奥斯卡">奥斯卡</a><b>(242407)</b></td>
                </tr>
                <tr>
              <td><a href="/tag/社会">社会</a><b>(201786)</b></td>
              <td><a href="/tag/2003">2003</a><b>(239948)</b></td>
              <td><a href="/tag/斯皮尔伯格">斯皮尔伯格</a><b>(246580)</b></td>
              <td><a href="/tag/アニメ">アニメ</a><b>(246754)</b></td>
                </tr>
                <tr>
              <td><a href="/tag/欧洲">欧洲</a><b>(244412)</b></td>
              <td><a href="/tag/自由">自由</a><b>(218553)</b></td>
              <td><a href="/tag/成龙">成龙</a><b>(235344)</b></td>
              <td><a href="/tag/生活">生活</a><b>(230098)</b></td>
                </tr>
                <tr>
              <td><a href="/tag/刘德华">刘德华</a><b>(234845)</b></td>
              <td><a href="/tag/恶搞">恶搞</a><b>(238977)</b></td>
              <td><a href="/tag/张国荣">张国荣</a><b>(220585)</b></td>
              <td><a href="/tag/冯小刚">冯小刚</a><b>(248065)</b></td>
                </tr>
                <tr>
              <td><a href="/tag/华语标签">华语标签</a><b>(181785)</b></td>
              <td><a href="/tag/2001">2001</a><b>(214763)</b></td>
              <td><a href="/tag/HBO">HBO</a><b>(184787)</b></td>
              <td><a href="/tag/pixar">pixar</a><b>(218806)</b></td>
                </tr>
                <tr>
              <td><a href="/tag/加拿大">加拿大</a><b>(218436)</b></td>
              <td><a href="/tag/音乐剧">音乐剧</a><b>(215444)</b></td>
              <td><a href="/tag/黑白">黑白</a><b>(214404)</b></td>
              <td><a href="/tag/Marvel">Marvel</a><b>(199671)</b></td>
                </tr>
                <tr>
              <td><a href="/tag/丧尸">丧尸</a><b>(174515)</b></td>
              <td><a href="/tag/公路">公路</a><b>(200377)</b></td>
              <td><a href="/tag/间谍">间谍</a><b>(197262)</b></td>
              <td><a href="/tag/杜琪峰">杜琪峰</a><b>(201237)</b></td>
                </tr>
                <tr>
              <td><a href="/tag/2002">2002</a><b>(190397)</b></td>
              <td><a href="/tag/李连杰">李连杰</a><b>(198242)</b></td>
              <td><a href="/tag/真人秀">真人秀</a><b>(186432)</b></td>
              <td><a href="/tag/西部">西部</a><b>(177975)</b></td>
                </tr>
                <tr>
              <td><a href="/tag/cult">cult</a><b>(196794)</b></td>
              <td><a href="/tag/台剧">台剧</a><b>(187308)</b></td>
              <td><a href="/tag/真实事件改编">真实事件改编</a><b>(123690)</b></td>
              <td><a href="/tag/国产电影">国产电影</a><b>(189102)</b></td>
                </tr>
                <tr>
              <td><a href="/tag/徐克">徐克</a><b>(193448)</b></td>
              <td><a href="/tag/英语标签">英语标签</a><b>(184469)</b></td>
              <td><a href="/tag/姜文">姜文</a><b>(203243)</b></td>
              <td><a href="/tag/1994">1994</a><b>(181625)</b></td>
                </tr>
                <tr>
              <td><a href="/tag/葛优">葛优</a><b>(180968)</b></td>
              <td><a href="/tag/澳大利亚">澳大利亚</a><b>(177392)</b></td>
              <td><a href="/tag/治愈系">治愈系</a><b>(179953)</b></td>
              <td><a href="/tag/综艺">综艺</a><b>(159067)</b></td>
                </tr>
                <tr>
              <td><a href="/tag/国产剧">国产剧</a><b>(137609)</b></td>
              <td><a href="/tag/我看过的电影">我看过的电影</a><b>(173638)</b></td>
              <td><a href="/tag/1990s">1990s</a><b>(174095)</b></td>
              <td><a href="/tag/哈利波特">哈利波特</a><b>(166149)</b></td>
                </tr>
                <tr>
              <td><a href="/tag/卡通">卡通</a><b>(164843)</b></td>
              <td><a href="/tag/日影">日影</a><b>(169587)</b></td>
              <td><a href="/tag/柯南">柯南</a><b>(165349)</b></td>
              <td><a href="/tag/自然">自然</a><b>(164440)</b></td>
                </tr>
                <tr>
              <td><a href="/tag/俄罗斯">俄罗斯</a><b>(156181)</b></td>
              <td><a href="/tag/二次元">二次元</a><b>(128311)</b></td>
              <td><a href="/tag/2000">2000</a><b>(164392)</b></td>
              <td><a href="/tag/意大利电影">意大利电影</a><b>(155795)</b></td>
                </tr>
                <tr>
              <td><a href="/tag/1997">1997</a><b>(158999)</b></td>
              <td><a href="/tag/北野武">北野武</a><b>(163462)</b></td>
              <td><a href="/tag/迪士尼">迪士尼</a><b>(145402)</b></td>
              <td><a href="/tag/灵异">灵异</a><b>(143478)</b></td>
                </tr>
                <tr>
              <td><a href="/tag/连续剧">连续剧</a><b>(155737)</b></td>
              <td><a href="/tag/1999">1999</a><b>(152411)</b></td>
              <td><a href="/tag/僵尸">僵尸</a><b>(158550)</b></td>
              <td><a href="/tag/2010s">2010s</a><b>(155821)</b></td>
                </tr>
                <tr>
              <td><a href="/tag/古天乐">古天乐</a><b>(153382)</b></td>
              <td><a href="/tag/美国动画">美国动画</a><b>(153983)</b></td>
              <td><a href="/tag/日语标签">日语标签</a><b>(127181)</b></td>
              <td><a href="/tag/欧美电影">欧美电影</a><b>(150746)</b></td>
                </tr>
                <tr>
              <td><a href="/tag/独立电影">独立电影</a><b>(143885)</b></td>
              <td><a href="/tag/李安">李安</a><b>(148779)</b></td>
              <td><a href="/tag/漫威">漫威</a><b>(134710)</b></td>
              <td><a href="/tag/TimBurton">TimBurton</a><b>(149525)</b></td>
                </tr>
                <tr>
              <td><a href="/tag/恐怖片">恐怖片</a><b>(143408)</b></td>
              <td><a href="/tag/德国电影">德国电影</a><b>(144416)</b></td>
              <td><a href="/tag/桂纶镁">桂纶镁</a><b>(143845)</b></td>
              <td><a href="/tag/治愈">治愈</a><b>(98176)</b></td>
                </tr>
                <tr>
              <td><a href="/tag/1998">1998</a><b>(142186)</b></td>
              <td><a href="/tag/震撼">震撼</a><b>(132894)</b></td>
              <td><a href="/tag/周迅">周迅</a><b>(140360)</b></td>
              <td><a href="/tag/Anime">Anime</a><b>(140794)</b></td>
                </tr>
                <tr>
              <td><a href="/tag/温暖">温暖</a><b>(134959)</b></td>
              <td><a href="/tag/周润发">周润发</a><b>(135963)</b></td>
              <td><a href="/tag/泰国电影">泰国电影</a><b>(138828)</b></td>
              <td><a href="/tag/动画电影">动画电影</a><b>(134406)</b></td>
                </tr>
                <tr>
              <td><a href="/tag/教育">教育</a><b>(136022)</b></td>
              <td><a href="/tag/日本动漫">日本动漫</a><b>(131983)</b></td>
              <td><a href="/tag/日剧SP">日剧SP</a><b>(130171)</b></td>
              <td><a href="/tag/摇滚">摇滚</a><b>(135173)</b></td>
                </tr>
                <tr>
              <td><a href="/tag/TV">TV</a><b>(135248)</b></td>
              <td><a href="/tag/伊朗">伊朗</a><b>(129306)</b></td>
              <td><a href="/tag/Disney">Disney</a><b>(123532)</b></td>
              <td><a href="/tag/les">les</a><b>(130223)</b></td>
                </tr>
                <tr>
              <td><a href="/tag/日劇">日劇</a><b>(130028)</b></td>
              <td><a href="/tag/金城武">金城武</a><b>(130474)</b></td>
              <td><a href="/tag/旅行">旅行</a><b>(127702)</b></td>
              <td><a href="/tag/爱尔兰">爱尔兰</a><b>(125353)</b></td>
                </tr>
                <tr>
              <td><a href="/tag/法律">法律</a><b>(112100)</b></td>
              <td><a href="/tag/瑞典">瑞典</a><b>(122924)</b></td>
              <td><a href="/tag/1995">1995</a><b>(119832)</b></td>
              <td><a href="/tag/情感">情感</a><b>(126340)</b></td>
                </tr>
                <tr>
              <td><a href="/tag/吉卜力">吉卜力</a><b>(124858)</b></td>
              <td><a href="/tag/默片">默片</a><b>(120879)</b></td>
              <td><a href="/tag/时尚">时尚</a><b>(118185)</b></td>
              <td><a href="/tag/刘青云">刘青云</a><b>(120802)</b></td>
                </tr>
          </tbody>
        </table>
      </div>

            </div>'''

import re
import urllib2
from bs4 import BeautifulSoup
import random
import time
import io

# 将tag写进文件
# with open("../data/tags.txt", "w") as tags_file:
#     for line in all_tag_str.split("\n"):
#         groups = re.findall('(?<=<a href="/tag/).+(?=")', line)
#         for group in groups:
#             tags_file.write(group + "\n")


def load_tags():
    ts = []
    with open("../data/tags.txt", "r") as tags_file:
        for one_t in tags_file:
            items = one_t.split(",")
            if len(items) < 2:
                ts.append((items[0].strip(), ("https://movie.douban.com/tag/%s?type=O" % items[0].strip())))
            else:
                ts.append((items[0].strip(), items[1].strip()))

    return ts

tags = load_tags()
for tag, url_ in tags:
    print tag
    has_next = True
    page_count = 1
    while has_next:
        movie_info = []
        print "Page:%d" % page_count
        print url_
        page_count += 1
        req = urllib2.urlopen(url_)
        origin_encode = req.headers['content-type'].split('charset=')[-1]
        try:
            html = req.read().decode(origin_encode).encode("utf-8")
            soup = BeautifulSoup(html, "lxml")
            # item_list = soup.select(".article > ul > li:nth-of-type(1) > div > div.p-img > a")
            content_list = soup.select(".article > div.")
            if len(content_list) != 1:
                print "未查找到内容div"
                has_next = False
            else:
                content = content_list[0]
                for table in content.select("table"):
                    rating_spans = table.select("span.rating_nums")
                    count_spans = table.select("span.pl")
                    if len(rating_spans) < 1 or len(count_spans) < 1:
                        continue
                    movie_info.append({
                        "name": re.sub(r"\n| ", "", table.select("a.")[0].text),
                        "href": table.select("a.")[0]["href"],
                        "rating": float(rating_spans[0].text),
                        "comment_count": count_spans[0].text
                    })
                page_list = soup.select(".article > div.paginator")
                if len(page_list) != 1:
                    print "未查找到下一页div"
                    has_next = False
                else:
                    page_div = page_list[0]
                    next_list = page_div.select("span.next a")
                    if len(next_list) > 0:
                        url_ = next_list[0]["href"]
                        has_next = True
                    else:
                        has_next = False
        except Exception, e:
            print e
            has_next = False
        # 每页保存
        with io.open("../data/movies.csv", "a", encoding="utf-8") as movies_file:
            for movie in movie_info:
                movies_file.write(
                    "%s,%s,%.1f,%s\n" % (movie["href"], movie["name"], movie["rating"], movie["comment_count"]))
        time.sleep(random.randint(5, 10) / 10.0)

    print "%s over" % tag
    

